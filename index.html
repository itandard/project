<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>포켓몬 카드 뽑기(by 홍정보)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary:#ffca3a; --primaryHover:#eaaa00;
      --red:#e03131; --blue:#1c7ed6; --gray:#868e96;
    }
    body { font-family:'Segoe UI',system-ui,-apple-system,Apple SD Gothic Neo,맑은 고딕,sans-serif; text-align:center; background:#eef7ff; padding:20px; }
    h1 { color:#d62828; }
    #controls { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    button {
      padding:12px 18px; font-size:16px; cursor:pointer; background:var(--primary);
      border:none; border-radius:12px; transition:.25s; box-shadow:0 2px 6px rgba(0,0,0,.05);
    }
    button:hover { background:var(--primaryHover); }

    #status { margin-top:8px; color:#555; font-size:14px; }
    .progress-wrap {
      width: 92%; max-width: 560px; height: 16px; margin: 10px auto 18px;
      border-radius: 10px; background: #dfe9f3; border: 1px solid #b8c3ce; overflow: hidden;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.08);
    }
    .progress-fill {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, #69db7c, #38d9a9 40%, #22b8cf 70%, #748ffc);
      transition: width .25s ease;
    }

    .card {
      width: 330px; margin: 20px auto; padding: 16px;
      border: 4px solid #333; border-radius: 16px; background: white;
      box-shadow: 0 0 15px rgba(0,0,0,0.2); animation: flip 0.6s ease-in-out;
      position: relative; text-align: left;
    }
    .card img { width: 150px; display: block; margin: 0 auto; }
    .card-name { margin: 10px 0; font-size: 22px; font-weight: bold; text-align: center; }
    .type-badge {
      display:inline-block; padding:3px 8px; margin:2px; border-radius:8px;
      background:#ccc; color:white; font-weight:bold; font-size:12px; text-transform:capitalize;
    }
    /* 타입별 색상 */
    .type-fire { background:#f08030; } .type-water { background:#6890f0; }
    .type-grass { background:#78c850; } .type-electric { background:#f8d030; color:#333; }
    .type-ice { background:#98d8d8; color:#000; } .type-fighting { background:#c03028; }
    .type-poison { background:#a040a0; } .type-ground { background:#e0c068; color:#000; }
    .type-flying { background:#a890f0; } .type-psychic { background:#f85888; }
    .type-dark { background:#705848; } .type-rock { background:#b8a038; }
    .type-bug { background:#a8b820; } .type-dragon { background:#7038f8; }
    .type-ghost { background:#705898; } .type-steel { background:#b8b8d0; color:#000; }
    .type-fairy { background:#f0b6bc; color:#000; } .type-normal { background:#a8a878; }

    /* 설명/능력치 테이블: 가운데 정렬 */
    table.info-table {
      width:100%; border-collapse:collapse; margin:10px auto; font-size:14px;
      text-align:center;
    }
    .info-table th { background:#f7f7f7; padding:6px; border-bottom:1px solid #ccc; width:38%; }
    .info-table td { padding:6px; border-bottom:1px solid #eee; }

    /* 테두리 규칙 */
    .border-red  { border-color: var(--red)  !important; }
    .border-blue { border-color: var(--blue) !important; }
    .border-gray { border-color: var(--gray) !important; }

    @keyframes flip { 0%{transform:rotateY(0)} 50%{transform:rotateY(90deg)} 100%{transform:rotateY(0)} }

    .deck-container { display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin-top: 20px; }
    .deck-card {
      width: 110px; padding: 6px; border: 3px solid #666; border-radius: 8px;
      background: white; display: flex; flex-direction: column; align-items: center; cursor: pointer;
    }
    .deck-card img { width: 72px; height: 72px; object-fit: contain; }
    .deck-card-name { font-size: 13px; margin-top: 5px; text-transform: capitalize; text-align: center; }

    /* 등급 텍스트 */
    .grade { font-weight: 600; }
    .grade-S { color: #d62828; font-weight: 800; }
  </style>
</head>
<body>
  <h1>포켓몬 카드 뽑기</h1>

  <div id="controls">
    <button id="draw-button">카드 뽑기!</button>
  </div>

  <div id="status">전체 목록 로딩 중… (잠시만 기다려 주세요)</div>
  <div class="progress-wrap" id="progress-wrap" aria-hidden="false">
    <div class="progress-fill" id="progress-fill" style="width:0%"></div>
  </div>

  <div id="card-slot"></div>

  <h2>내 카드 덱</h2>
  <div class="deck-container" id="deck-container"></div>

  <audio id="draw-sound" src="https://www.myinstants.com/media/sounds/pokemon.mp3"></audio>

<script>
  // ===== 설정/상수 =====
  const POKEMON_INDEX_START = 'https://pokeapi.co/api/v2/pokemon?limit=200&offset=0';
  const speciesAPI = 'https://pokeapi.co/api/v2/pokemon-species/';

  // 상태
  let isLoadingIndex = false;
  let indexList = [];      // [{name,url}, ...]
  let nextIndexUrl = POKEMON_INDEX_START;
  let totalCount = null;

  // 상세 캐시
  const cache = new Map(); // key: id/name/url -> detail object

  // 등급 확률/배수
  const gradeWeights = { S: 20, A: 35, B: 30, C: 15 };
  const gradeMultiplier = { S: 1.00, A: 0.95, B: 0.90, C: 0.85 };

  const statNamesKor = {
    hp: 'HP', attack: '공격', defense: '방어',
    'special-attack': '특수공격', 'special-defense': '특수방어', speed: '스피드'
  };

  // ===== 유틸 =====
  const sleep = ms => new Promise(r => setTimeout(r, ms));
  async function fetchJSON(url, retries = 3, backoffMs = 500) {
    for (let i = 0; i <= retries; i++) {
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } catch (e) {
        if (i === retries) throw e;
        await sleep(backoffMs * (i + 1));
      }
    }
  }

  function setStatus(msg) {
    const el = document.getElementById('status');
    if (el) el.textContent = msg;
  }
  function setProgress(pct) {
    const bar = document.getElementById('progress-fill');
    if (bar) bar.style.width = Math.max(0, Math.min(100, pct)) + '%';
  }
  function toggleProgress(show) {
    const wrap = document.getElementById('progress-wrap');
    if (wrap) wrap.style.display = show ? 'block' : 'none';
  }

  function pickGrade() {
    const r = Math.random() * 100;
    let acc = 0;
    for (const [g, w] of Object.entries(gradeWeights)) { acc += w; if (r < acc) return g; }
    return 'C';
  }
  function applyGrades(stats) {
    return stats.map(s => {
      const g = pickGrade();
      return { ...s, value: Math.round(s.value * gradeMultiplier[g]), grade: g };
    });
  }
  function isGoodPokemon(stats) {
    const atk = stats.find(s => s.name === 'attack')?.value || 0;
    const spd = stats.find(s => s.name === 'speed')?.value || 0;
    return atk > 100 || spd > 100;
  }
  function countGrades(stats) {
    let s = 0, a = 0;
    for (const st of stats) { if (st.grade === 'S') s++; else if (st.grade === 'A') a++; }
    return { s, a };
  }
  function borderClassByGrades(stats) {
    const { s, a } = countGrades(stats);
    if (s >= 3) return 'border-red';          // S 3개 이상
    if (s === 2 && a >= 1) return 'border-blue'; // S 2개 + A 1개 이상
    return 'border-gray';
  }

  // ===== 인덱스(가벼운 목록) 전체 자동 로딩 =====
  async function loadIndexAll() {
    if (!nextIndexUrl || isLoadingIndex) return;
    isLoadingIndex = true;
    toggleProgress(true);
    setStatus('전체 목록 로딩 중… (잠시만 기다려 주세요)');

    try {
      while (nextIndexUrl) {
        const page = await fetchJSON(nextIndexUrl);
        totalCount ??= page.count || 0;

        indexList.push(...page.results); // name,url
        nextIndexUrl = page.next;

        const pct = totalCount ? Math.round((indexList.length / totalCount) * 100) : 0;
        setStatus(`전체 목록 로딩 중… ${indexList.length}/${totalCount || '?'} (${pct}%)`);
        setProgress(pct);

        // API 부담 완화
        if (nextIndexUrl) await sleep(150);
      }

      setStatus(`목록 로딩 완료! 총 ${indexList.length}마리`);
      setProgress(100);
      toggleProgress(false);
    } catch (e) {
      console.error(e);
      setStatus('목록 로딩 실패 (네트워크/레이트 리밋 가능)');
      toggleProgress(false);
    } finally {
      isLoadingIndex = false;
    }
  }

  // ===== 상세 로딩(뽑을 때 1마리만) + 캐시 =====
  async function getPokemonDetail(urlOrName) {
    if (cache.has(urlOrName)) return cache.get(urlOrName);

    const info = await fetchJSON(
      typeof urlOrName === 'string' && urlOrName.startsWith('http')
        ? urlOrName
        : `https://pokeapi.co/api/v2/pokemon/${urlOrName}`
    );
    const species = await fetchJSON(info.species?.url || (speciesAPI + info.name));

    const nameKo = species.names.find(n => n.language.name === 'ko')?.name || info.name;
    const types = info.types.map(t => t.type.name);
    const stats = info.stats.map(s => ({ name: s.stat.name, value: s.base_stat }));
    const flavor = (species.flavor_text_entries.find(e => e.language.name === 'ko')?.flavor_text || '').replace(/\n|\f/g,' ');

    const thumb =
      info.sprites.front_default ||
      info.sprites.other?.dream_world?.front_default ||
      info.sprites.other?.home?.front_default ||
      info.sprites.other?.['official-artwork']?.front_default ||
      '';
    const image =
      info.sprites.other?.['official-artwork']?.front_default ||
      info.sprites.other?.home?.front_default ||
      thumb;

    const obj = { id: info.id, nameKo, image, thumb, types, stats, flavor };
    cache.set(urlOrName, obj);
    cache.set(info.name, obj);
    cache.set(info.id, obj);
    if (info.species?.url) cache.set(info.species.url, obj);
    return obj;
  }

  // ===== 렌더링 =====
  function renderCard(p) {
    const statsToUse = p.gradedStats || p.stats;
    const good = isGoodPokemon(statsToUse);
    const borderCls = borderClassByGrades(statsToUse);
    const cls = `card ${borderCls} ${good ? 'rarity-good' : ''}`;
    const badgeHTML = p.types.map(t => `<span class="type-badge type-${t}">${t}</span>`).join(' ');

    const rows = statsToUse.map(s => {
      const gradeHTML = s.grade ? ` <span class="grade ${s.grade === 'S' ? 'grade-S' : ''}">(${s.grade})</span>` : '';
      return `<tr><th>${statNamesKor[s.name]}</th><td>${s.value}${gradeHTML}</td></tr>`;
    }).join('');

    return `
      <div class="${cls}">
        <img src="${p.image}" alt="${p.nameKo}" loading="eager" decoding="async">
        <div class="card-name">${p.nameKo} (#${p.id})</div>
        <div style="text-align:center;margin-bottom:6px;">${badgeHTML}</div>
        <table class="info-table">
          <tr><th>설명</th><td>${p.flavor || '설명이 없습니다.'}</td></tr>
          ${rows}
        </table>
      </div>
    `;
  }

  // ===== 이벤트 =====
  const drawBtn = document.getElementById('draw-button');
  drawBtn.addEventListener('click', async () => {
    // 요구 2: 로드되기 전에는 대기 메시지
    if (isLoadingIndex || !indexList.length) {
      alert('아직 전체 목록을 불러오는 중입니다. 잠시만 대기해 주세요!');
      return;
    }

    // 인덱스에서 랜덤 선택 → 상세 1마리 로드
    const meta = indexList[Math.floor(Math.random() * indexList.length)];
    setStatus('상세 로딩 중…');
    try {
      const pick = await getPokemonDetail(meta.url);
      if (!pick.gradedStats) pick.gradedStats = applyGrades(pick.stats);

      const audio = document.getElementById('draw-sound');
      try { audio.currentTime = 0; audio.play(); } catch (_) {}

      document.getElementById('card-slot').innerHTML = renderCard(pick);

      const deck = document.getElementById('deck-container');
      const div = document.createElement('div');
      div.className = 'deck-card';
      div.innerHTML = `
        <img src="${pick.thumb}" alt="" loading="lazy" decoding="async">
        <div class="deck-card-name">${pick.nameKo}</div>`;
      div.addEventListener('click', () => {
        document.getElementById('card-slot').innerHTML = renderCard(pick);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
      deck.appendChild(div);

      setStatus(`뽑기 완료! (총 인덱스 ${indexList.length}/${totalCount || '?'})`);
    } catch (e) {
      console.error(e);
      setStatus('상세 로딩 실패 (네트워크/레이트 리밋 가능)');
    }
  });

  // ===== 초기 구동: 전체 인덱스 자동 로딩 =====
  (async function init() {
    await loadIndexAll(); // 전 페이지 모두 로드
  })();
</script>
</body>
</html>
