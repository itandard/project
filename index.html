<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í¬ì¼“ëª¬ ì¹´ë“œ ë½‘ê¸°(by í™ì •ë³´)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --primary:#ffca3a; --primaryHover:#eaaa00;
      --red:#e03131; --blue:#1c7ed6; --gray:#868e96;
      --text:#222; --muted:#555; --bg:#eef7ff; --card:#fff;
      /* âœ… ì¹´ë“œ/ë± í­ ë¶„ë¦¬: ì¹´ë“œëŠ” ìœ ì§€, ë±ì€ ë” ë„“ê²Œ */
      --cardW: min(320px, 85vw);
      --deckW: min(720px, 96vw);
    }
    html,body{height:100%}
    body{
      font-family:'Segoe UI',system-ui,-apple-system,Apple SD Gothic Neo,ë§‘ì€ ê³ ë”•,sans-serif;
      color:var(--text); background:var(--bg); margin:0; padding:16px;
      text-align:center;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    h1{color:#d62828; font-size:clamp(20px,4.5vw,28px); margin:6px 0 14px}

    /* ì»¨íŠ¸ë¡¤ - CTA ë²„íŠ¼ ê°•í™” */
    #controls{display:flex; gap:10px; justify-content:center; flex-wrap:wrap}
    .cta{
      --ring: rgba(255,202,58,.55);
      padding:14px 22px; font-size:clamp(15px,4vw,18px);
      cursor:pointer; border:none; border-radius:14px;
      background:linear-gradient(180deg,#ffe066 0%, #ffca3a 55%, #eaaa00 100%);
      color:#2b2b2b; font-weight:900; letter-spacing:.3px;
      box-shadow:
        0 10px 22px rgba(255,170,0,.35),
        0 2px 6px rgba(0,0,0,.08),
        inset 0 1px 0 rgba(255,255,255,.7);
      transform:translateY(0); transition:.2s ease;
      position:relative; min-width:160px;
    }
    .cta::after{ /* í•˜ì´ë¼ì´íŠ¸ ê´‘íƒ */
      content:""; position:absolute; inset:0; border-radius:inherit;
      background:linear-gradient(180deg,rgba(255,255,255,.6),transparent 40%);
      pointer-events:none; mix-blend-mode:soft-light;
    }
    .cta:hover{ transform:translateY(-1px); box-shadow:
        0 16px 34px rgba(255,170,0,.45),
        0 2px 10px rgba(0,0,0,.10),
        inset 0 1px 0 rgba(255,255,255,.85); }
    .cta:active{ transform:translateY(0); filter:saturate(1.05) }
    .cta:focus-visible{
      outline:none; box-shadow:
        0 0 0 4px var(--ring),
        0 10px 22px rgba(255,170,0,.35),
        inset 0 1px 0 rgba(255,255,255,.85);
    }
    @media (max-width:480px){ .cta{flex:1 1 100%; min-width:unset} }

    /* ìƒíƒœ + ì§„í–‰ë°” */
    #status{margin-top:8px; color:var(--muted); font-size:clamp(12px,3.2vw,14px)}
    .progress-wrap{
      width:min(560px,92vw); height:14px; margin:10px auto 18px;
      border-radius:10px; background:#dfe9f3; border:1px solid #b8c3ce; overflow:hidden;
      box-shadow:inset 0 1px 2px rgba(0,0,0,.08)
    }
    .progress-fill{
      height:100%; width:0%;
      background:linear-gradient(90deg,#69db7c,#38d9a9 40%,#22b8cf 70%,#748ffc);
      transition:width .25s ease
    }

    /* ë©”ì¸ ì¹´ë“œ */
    .card{
      width:var(--cardW);
      margin:16px auto;
      padding:14px 18px 16px;
      border:4px solid #333; border-radius:16px; background:var(--card);
      box-shadow:0 0 15px rgba(0,0,0,.2);
      animation:flip .6s ease-in-out;
      text-align:center;
      box-sizing:border-box; /* í…Œë‘ë¦¬/íŒ¨ë”© í¬í•¨ */
    }
    .card img{ width:min(150px,55vw); max-width:100%; height:auto; display:block; margin:4px auto 6px }
    .card-name{ margin:8px 0; font-size:clamp(18px,4.5vw,22px); font-weight:800 }
    .type-badge{ display:inline-block; padding:3px 8px; margin:2px; border-radius:8px;
      background:#ccc; color:#fff; font-weight:700; font-size:12px; text-transform:capitalize }
    .type-fire{background:#f08030}.type-water{background:#6890f0}
    .type-grass{background:#78c850}.type-electric{background:#f8d030;color:#333}
    .type-ice{background:#98d8d8;color:#000}.type-fighting{background:#c03028}
    .type-poison{background:#a040a0}.type-ground{background:#e0c068;color:#000}
    .type-flying{background:#a890f0}.type-psychic{background:#f85888}
    .type-dark{background:#705848}.type-rock{background:#b8a038}
    .type-bug{background:#a8b820}.type-dragon{background:#7038f8}
    .type-ghost{background:#705898}.type-steel{background:#b8b8d0;color:#000}
    .type-fairy{background:#f0b6bc;color:#000}.type-normal{background:#a8a878}
    table.info-table{ width:100%; border-collapse:collapse; margin:8px auto 0;
      font-size:clamp(12px,3.2vw,14px); text-align:center }
    .info-table th{background:#f7f7f7; padding:6px; border-bottom:1px solid #ccc; width:40%; font-weight:700}
    .info-table td{padding:6px; border-bottom:1px solid #eee}

    .border-red{border-color:var(--red)!important}
    .border-blue{border-color:var(--blue)!important}
    .border-gray{border-color:var(--gray)!important}

    @media (prefers-reduced-motion:reduce){ .card{animation:none} }
    @keyframes flip{0%{transform:rotateY(0)}50%{transform:rotateY(90deg)}100%{transform:rotateY(0)}}

    /* ë± ì„¹ì…˜: ì¹´ë“œì™€ ë˜‘ê°™ì€ í­ */
    .deck-section{
      width:var(--deckW);
      margin:18px auto 8px;
      background:#fff; border:4px solid #333; border-radius:16px;
      box-shadow:0 0 12px rgba(0,0,0,.12);
      padding:12px;                 /* ë‚´ë¶€ ì—¬ë°±ì€ ìœ ì§€ */
      box-sizing:border-box;        /* í…Œë‘ë¦¬/íŒ¨ë”© í¬í•¨ */
      display:none;                 /* ì²« ë½‘ê¸° ì „ ìˆ¨ê¹€ */
    }
    .deck-section.show{ display:block }
    
    /* ë± ì œëª© */
    .deck-title{
      font-size:clamp(16px,4vw,20px);
      margin:12px 0 10px;
      font-weight:900; color:#1f1f1f;
    }

    /* ë± ê·¸ë¦¬ë“œ: ì•ˆìª½ íŒ¨ë”©ì„ ì—¬ê¸°ì— */
    .deck-container{
      display:grid; gap:10px;
      grid-template-columns:repeat(auto-fill, minmax(100px, 1fr)); /* 88px â†’ 100pxë¡œ í™•ëŒ€ */
      padding:0 4px 6px; /* ì¢Œìš° ê· ë“±, ì‚´ì§ë§Œ */
      box-sizing:border-box;
    }
    .deck-card{
      padding:6px; border:3px solid #666; border-radius:10px; background:#fff;
      display:flex; flex-direction:column; align-items:center; cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,.06);
      transition:transform .15s ease, box-shadow .15s ease;
    }
    .deck-card:hover{
      transform:translateY(-1px);
      box-shadow:0 6px 14px rgba(0,0,0,.10);
    }
    .deck-card img{width:72px; height:72px; object-fit:contain}
    .deck-card-name{font-size:12px; margin-top:5px; text-transform:capitalize}

    /* ë“±ê¸‰ í…ìŠ¤íŠ¸ */
    .grade{font-weight:700}
    .grade-S{color:#d62828; font-weight:900}
  </style>
</head>
<body>
  <h1>í¬ì¼“ëª¬ ì¹´ë“œ ë½‘ê¸°</h1>

  <div id="controls">
    <button id="draw-button" class="cta" aria-label="ì¹´ë“œ ë½‘ê¸°">ğŸ´ ì¹´ë“œ ë½‘ê¸°!</button>
  </div>

  <div id="status">ì „ì²´ ëª©ë¡ ë¡œë”© ì¤‘â€¦ (ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”)</div>
  <div class="progress-wrap" id="progress-wrap" aria-hidden="false">
    <div class="progress-fill" id="progress-fill" style="width:0%"></div>
  </div>

  <div id="card-slot"></div>

  <!-- ë± ì„¹ì…˜: ì²˜ìŒì—” ìˆ¨ê¹€, ì²« ì¹´ë“œ ë½‘íˆë©´ .show ë¶€ì—¬ -->
  <section id="deck-section" class="deck-section" aria-hidden="true">
    <h2 class="deck-title">ë‚´ ì¹´ë“œ ë±</h2>
    <div class="deck-container" id="deck-container"></div>
  </section>

<script>
  /* =============== ì„¤ì •/ìƒíƒœ =============== */
  const POKEMON_INDEX_START = 'https://pokeapi.co/api/v2/pokemon?limit=200&offset=0';
  const speciesAPI = 'https://pokeapi.co/api/v2/pokemon-species/';
  const FETCH_TIMEOUT_MS = 8000;
  const INDEX_FALLBACK_AFTER_MS = 6000;

  let isLoadingIndex = false;
  let indexList = [];      // [{ name, url }]
  let nextIndexUrl = POKEMON_INDEX_START;
  let totalCount = null;
  let fallbackMode = false;

  const cache = new Map();

  const gradeWeights    = { S: 20, A: 35, B: 30, C: 15 };
  const gradeMultiplier = { S: 1.00, A: 0.95, B: 0.90, C: 0.85 };

  const statNamesKor = {
    hp: 'ì²´ë ¥', attack: 'ê³µê²©', defense: 'ë°©ì–´',
    'special-attack': 'íŠ¹ìˆ˜ê³µê²©', 'special-defense': 'íŠ¹ìˆ˜ë°©ì–´', speed: 'ìŠ¤í”¼ë“œ'
  };

  /* =============== ìœ í‹¸ =============== */
  const sleep = ms => new Promise(r => setTimeout(r, ms));

  async function fetchJSON(url, retries = 2, backoffMs = 500) {
    for (let i = 0; i <= retries; i++) {
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), FETCH_TIMEOUT_MS);
      try {
        const res = await fetch(url, { signal: controller.signal });
        clearTimeout(t);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return await res.json();
      } catch (e) {
        clearTimeout(t);
        if (i === retries) throw e;
        await sleep(backoffMs * (i + 1));
      }
    }
  }

  function setStatus(msg){ const el = document.getElementById('status'); if (el) el.textContent = msg; }
  function setProgress(pct){ const bar = document.getElementById('progress-fill'); if (bar) bar.style.width = Math.max(0,Math.min(100,pct))+'%'; }
  function toggleProgress(show){ const wrap = document.getElementById('progress-wrap'); if (wrap) wrap.style.display = show?'block':'none'; }

  function pickGrade(){
    const r = Math.random()*100; let acc = 0;
    for (const [g,w] of Object.entries(gradeWeights)){ acc += w; if (r < acc) return g; }
    return 'C';
  }
  function applyGrades(stats){
    return stats.map(s=>{
      const g = pickGrade();
      return { ...s, value: Math.round(s.value * gradeMultiplier[g]), grade: g };
    });
  }
  function countGrades(stats){ let s=0, a=0; for (const st of stats){ if (st.grade==='S') s++; else if (st.grade==='A') a++; } return { s, a }; }
  function borderClassByGrades(stats){
    const { s, a } = countGrades(stats);
    if (s >= 3) return 'border-red';
    if (s === 2 && a >= 1) return 'border-blue';
    return 'border-gray';
  }

  /* ê³ ìœ  ì½”ë“œ ìƒì„±: #5H22 í˜•íƒœ 4ìë¦¬ (í˜¼ë™ë¬¸ì ì œì™¸) */
  function genCode(n = 4){
    const chars = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789';
    let out = '';
    for (let i=0;i<n;i++) out += chars[Math.floor(Math.random()*chars.length)];
    return out;
  }

  /* =============== í´ë°± ì¸ë±ìŠ¤ =============== */
  function buildFallbackIndex(maxId = 1025){
    const arr = [];
    for(let id=1; id<=maxId; id++){
      arr.push({ name: String(id), url: `https://pokeapi.co/api/v2/pokemon/${id}` });
    }
    return arr;
  }

  /* =============== ì „ì²´ ì¸ë±ìŠ¤ ë¡œë”©(+í´ë°±) =============== */
  async function loadIndexAll(){
    if (!nextIndexUrl || isLoadingIndex) return;
    isLoadingIndex = true;
    toggleProgress(true);
    setStatus('ì „ì²´ ëª©ë¡ ë¡œë”© ì¤‘â€¦ (ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”)');

    const fbTimer = setTimeout(()=>{
      if (!indexList.length) {
        fallbackMode = true;
        indexList = buildFallbackIndex();
        totalCount = indexList.length;
        setProgress(30);
        setStatus('ë¹ ë¥¸ ì‹œì‘ ëª¨ë“œë¡œ ì „í™˜: ì¸ë±ìŠ¤ê°€ ëŠë ¤ì„œ ID ê¸°ë°˜ìœ¼ë¡œ ë°”ë¡œ ë½‘ì„ ìˆ˜ ìˆì–´ìš”.');
      }
    }, INDEX_FALLBACK_AFTER_MS);

    try{
      while (nextIndexUrl) {
        const page = await fetchJSON(nextIndexUrl);
        totalCount ??= page.count || 0;

        if (fallbackMode && page?.results?.length) {
          fallbackMode = false;
          indexList = [];
          setStatus('ì •ì‹ ì¸ë±ìŠ¤ ì—°ê²°ë¨. ë°ì´í„° ì •í™•ë„ë¥¼ ë†’ì´ëŠ” ì¤‘â€¦');
        }

        indexList.push(...page.results);
        nextIndexUrl = page.next;

        const pct = totalCount ? Math.round((indexList.length / totalCount) * 100) : 0;
        setStatus(`ì „ì²´ ëª©ë¡ ë¡œë”© ì¤‘â€¦ ${indexList.length}/${totalCount || '?'} (${pct}%)`);
        setProgress(pct);

        if (nextIndexUrl) await sleep(150);
      }

      clearTimeout(fbTimer);
      setStatus(`ëª©ë¡ ë¡œë”© ì™„ë£Œ! ì´ ${indexList.length}ë§ˆë¦¬`);
      setProgress(100);
      toggleProgress(false);
    }catch(e){
      clearTimeout(fbTimer);
      console.error(e);
      if (!indexList.length){
        fallbackMode = true;
        indexList = buildFallbackIndex();
        totalCount = indexList.length;
        setStatus('ì¸ë±ìŠ¤ ë¡œë”© ì‹¤íŒ¨ â†’ ë¹ ë¥¸ ì‹œì‘ ëª¨ë“œë¡œ ê³„ì†í•©ë‹ˆë‹¤.');
        toggleProgress(false);
      }else{
        setStatus('ì¼ë¶€ ì¸ë±ìŠ¤ ë¡œë”© ì‹¤íŒ¨ (ë„¤íŠ¸ì›Œí¬/ë ˆì´íŠ¸ ë¦¬ë°‹ ê°€ëŠ¥). ê³„ì† ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        toggleProgress(false);
      }
    }finally{
      isLoadingIndex = false;
    }
  }

  /* =============== ìƒì„¸ ë¡œë”© + ìºì‹œ =============== */
  async function getPokemonDetail(urlOrName){
    if (cache.has(urlOrName)) return cache.get(urlOrName);

    const info = await fetchJSON(
      (typeof urlOrName==='string' && urlOrName.startsWith('http')) ? urlOrName
        : `https://pokeapi.co/api/v2/pokemon/${urlOrName}`
    );
    const species = await fetchJSON(info.species?.url || (speciesAPI + info.name));

    const nameKo = species.names.find(n=>n.language.name==='ko')?.name || info.name;
    const types  = info.types.map(t=>t.type.name);
    const stats  = info.stats.map(s=>({ name:s.stat.name, value:s.base_stat }));
    const flavor = (species.flavor_text_entries.find(e=>e.language.name==='ko')?.flavor_text || '').replace(/\n|\f/g,' ');

    const thumb =
      info.sprites.front_default ||
      info.sprites.other?.dream_world?.front_default ||
      info.sprites.other?.home?.front_default ||
      info.sprites.other?.['official-artwork']?.front_default || '';
    const image =
      info.sprites.other?.['official-artwork']?.front_default ||
      info.sprites.other?.home?.front_default ||
      thumb;

    const obj = { id: info.id, nameKo, image, thumb, types, stats, flavor };
    cache.set(urlOrName, obj);
    cache.set(info.name, obj);
    cache.set(info.id, obj);
    if (info.species?.url) cache.set(info.species.url, obj);
    return obj;
  }

  /* =============== ë Œë”ë§ =============== */
  function renderCard(p){
    const statsToUse = p.gradedStats || p.stats;
    const borderCls = borderClassByGrades(statsToUse);
    const cls = `card ${borderCls}`;
    const badgeHTML = p.types.map(t=>`<span class="type-badge type-${t}">${t}</span>`).join(' ');
    const statNamesKor = {
      hp: 'HP', attack: 'ê³µê²©', defense: 'ë°©ì–´',
      'special-attack': 'íŠ¹ìˆ˜ê³µê²©', 'special-defense': 'íŠ¹ìˆ˜ë°©ì–´', speed: 'ìŠ¤í”¼ë“œ'
    };
    const rows = statsToUse.map(s=>{
      const gradeHTML = s.grade ? ` <span class="grade ${s.grade==='S' ? 'grade-S' : ''}">(${s.grade})</span>` : '';
      return `<tr><th>${statNamesKor[s.name]}</th><td>${s.value}${gradeHTML}</td></tr>`;
    }).join('');

    return `
      <div class="${cls}">
        <img src="${p.image}" alt="${p.nameKo}" loading="eager" decoding="async">
        <div class="card-name">${p.nameKo} (#${p.id})</div>
        <div style="margin-bottom:6px;">${badgeHTML}</div>
        <table class="info-table">
          <tr><th>ì„¤ëª…</th><td>${p.flavor || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}</td></tr>
          ${rows}
        </table>
      </div>
    `;
  }

  /* =============== â€œë¾°ë¡œë¡±â€ ì›¹ì˜¤ë””ì˜¤ =============== */
  let audioCtx = null;
  function playChime(){
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const ctx = audioCtx;
      const now = ctx.currentTime;
      const freqs = [880, 1175, 1568];
      freqs.forEach((f, i)=>{
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.setValueAtTime(f*0.9, now + i*0.04);
        o.frequency.exponentialRampToValueAtTime(f*1.1, now + i*0.04 + 0.25);
        g.gain.setValueAtTime(0.0001, now + i*0.04);
        g.gain.exponentialRampToValueAtTime(0.25, now + i*0.04 + 0.03);
        g.gain.exponentialRampToValueAtTime(0.0001, now + i*0.04 + 0.28);
        o.connect(g).connect(ctx.destination);
        o.start(now + i*0.04);
        o.stop(now + i*0.04 + 0.3);
      });
    }catch(_){}
  }

  /* =============== ì´ë²¤íŠ¸ =============== */
  const drawBtn = document.getElementById('draw-button');
  drawBtn.addEventListener('click', async ()=>{
    if (!indexList.length) {
      fallbackMode = true;
      indexList = buildFallbackIndex();
      totalCount = indexList.length;
      setStatus('ë¹ ë¥¸ ì‹œì‘ ëª¨ë“œ: ì¸ë±ìŠ¤ ì—†ì´ ë°”ë¡œ ë½‘ê¸°ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.');
      toggleProgress(false);
    }

    const meta = indexList[Math.floor(Math.random()*indexList.length)];
    setStatus('ìƒì„¸ ë¡œë”© ì¤‘â€¦');
    try{
      const pick = await getPokemonDetail(meta.url);
      if (!pick.gradedStats) pick.gradedStats = (function(stats){
        const gradeMultiplier = { S:1.00, A:0.95, B:0.90, C:0.85 };
        const gradeWeights    = { S:20, A:35, B:30, C:15 };
        const rpick = () => {
          const r = Math.random()*100; let acc=0;
          for(const [g,w] of Object.entries(gradeWeights)){acc+=w;if(r<acc)return g;}
          return 'C';
        };
        return stats.map(s=>{ const g=rpick(); return { ...s, value:Math.round(s.value*gradeMultiplier[g]), grade:g }; });
      })(pick.stats);

      playChime();
      document.getElementById('card-slot').innerHTML = renderCard(pick);

      // ë± ì„¹ì…˜ í‘œì‹œ(ì²« ì¹´ë“œ ë•Œë§Œ show í´ë˜ìŠ¤ ë¶€ì—¬)
      const deckSection = document.getElementById('deck-section');
      if (!deckSection.classList.contains('show')){
        deckSection.classList.add('show');
        deckSection.setAttribute('aria-hidden','false');
      }

      // ë± ì¸ë„¤ì¼ ì¶”ê°€
      const deck = document.getElementById('deck-container');
      const div = document.createElement('div');
      div.className = 'deck-card';
      div.innerHTML = `
        <img src="${pick.thumb}" alt="" loading="lazy" decoding="async">
        <div class="deck-card-name">${pick.nameKo}</div>`;
      div.addEventListener('click', ()=>{
        document.getElementById('card-slot').innerHTML = renderCard(pick);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
      deck.appendChild(div);

      // ê³ ìœ ë²ˆí˜¸ 4ìë¦¬ ìƒì„± í›„ ìƒíƒœì— í‘œì‹œ
      const uniq = genCode(4);
      setStatus(`ê³ ìœ ë²ˆí˜¸ : #${uniq}`);
    }catch(e){
      console.error(e);
      setStatus('ìƒì„¸ ë¡œë”© ì‹¤íŒ¨ (ë„¤íŠ¸ì›Œí¬/ë ˆì´íŠ¸ ë¦¬ë°‹ ê°€ëŠ¥). ë‹¤ë¥¸ ì¹´ë“œë¥¼ ì‹œë„í•´ ë³´ì„¸ìš”.');
    }
  });

  /* =============== ì´ˆê¸° êµ¬ë™ =============== */
  (async function init(){ await loadIndexAll(); })();
</script>
</body>
</html>
