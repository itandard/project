<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í¬ì¼“ëª¬ ì¹´ë“œ ëœë¤ ë½‘ê¸°(by í™ì •ë³´)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --contentW: min(320px, 85vw);

      /* í…Œë§ˆ */
      --text:#1b1b1b; --bg:#fafafa; --muted:#5f6b7a;
      --red:#d62828; --blue:#3a86ff; --gray:#333;

      /* ì—°ì¶œ íŒŒë¼ë¯¸í„° */
      --flipDur: 6.5s;         /* â± í”Œë¦½ ì‹œê°„ (ëŠ˜ë¦¼) */
      --sparkleDur: 3100ms;    /* âœ¨ ë°˜ì§ì´ ì‹œê°„ */
      --sparkleCount: 70;      /* âœ¨ ê¸°ë³¸ ê°œìˆ˜ */
    }
    html,body{height:100%}
    body{
      font-family:'Segoe UI',system-ui,-apple-system,Apple SD Gothic Neo,ë§‘ì€ ê³ ë”•,sans-serif;
      color:var(--text); background:var(--bg); margin:0; padding:16px; text-align:center;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* ì‹¬í”Œ & ì„¸ë ¨ íƒ€ì´í‹€ */
    h1.title{
      font-size: clamp(28px, 6vw, 42px);
      font-weight: 800;
      margin: 10px 0 18px;
      background: linear-gradient(90deg, #ffde59, #ff914d);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 1px 2px 4px rgba(0,0,0,0.25);
      animation: fadeIn 1s ease;
    }
    @keyframes fadeIn { from {opacity:0; transform:translateY(-8px)} to {opacity:1; transform:translateY(0)} }

    /* ì»¨íŠ¸ë¡¤ */
    #controls{display:flex; gap:10px; justify-content:center; flex-wrap:wrap}
    .cta{
      --ring: rgba(255,202,58,.55);
      padding:14px 22px; font-size:clamp(15px,4vw,18px);
      cursor:pointer; border:none; border-radius:14px;
      background:linear-gradient(180deg,#ffe066 0%, #ffca3a 55%, #eaaa00 100%);
      color:#2b2b2b; font-weight:900; letter-spacing:.3px;
      box-shadow:0 10px 22px rgba(255,170,0,.35), 0 2px 6px rgba(0,0,0,.08), inset 0 1px 0 rgba(255,255,255,.7);
      transform:translateY(0); transition:.2s ease; position:relative; min-width:160px; touch-action:manipulation;
    }
    .cta[disabled]{ opacity:.6; cursor:not-allowed; }
    .cta::after{ content:""; position:absolute; inset:0; border-radius:inherit; background:linear-gradient(180deg,rgba(255,255,255,.6),transparent 40%); pointer-events:none; mix-blend-mode:soft-light; }
    .cta:hover{ transform:translateY(-1px); box-shadow:0 16px 34px rgba(255,170,0,.45), 0 2px 10px rgba(0,0,0,.10), inset 0 1px 0 rgba(255,255,255,.85); }
    .cta:active{ transform:translateY(0); filter:saturate(1.05) }
    .cta:focus-visible{ outline:none; box-shadow:0 0 0 4px var(--ring), 0 10px 22px rgba(255,170,0,.35), inset 0 1px 0 rgba(255,255,255,.85); }
    @media (max-width:480px){ .cta{flex:1 1 100%; min-width:unset} }

    /* ìƒíƒœ/í”„ë¡œê·¸ë ˆìŠ¤ */
    #status{margin-top:8px; color:var(--muted); font-size:clamp(12px,3.2vw,14px)}
    .progress-wrap{
      width:min(560px,92vw); height:14px; margin:10px auto 18px;
      border-radius:10px; background:#dfe9f3; border:1px solid #b8c3ce; overflow:hidden; box-shadow:inset 0 1px 2px rgba(0,0,0,.08)
    }
    .progress-fill{ height:100%; width:0%; background:linear-gradient(90deg,#69db7c,#38d9a9 40%,#22b8cf 70%,#748ffc); transition:width .25s ease }

    /* ë©”ì¸ ì¹´ë“œ(ì•ë©´) */
    .card{
      width:var(--contentW);
      margin:16px auto; padding:14px 18px 16px;
      border:4px solid #333; border-radius:16px; background:#fff;
      box-shadow:0 0 15px rgba(0,0,0,.2); text-align:center; box-sizing:border-box;
    }
    .card img{ width:min(150px,55vw); max-width:100%; height:auto; display:block; margin:4px auto 6px }
    .card-name{ margin:8px 0; font-size:clamp(18px,4.5vw,22px); font-weight:800 }
    .type-badge{ display:inline-block; padding:3px 8px; margin:2px; border-radius:8px; background:#ccc; color:#fff; font-weight:700; font-size:12px; text-transform:capitalize }
    .type-fire{background:#f08030}.type-water{background:#6890f0}
    .type-grass{background:#78c850}.type-electric{background:#f8d030;color:#333}
    .type-ice{background:#98d8d8;color:#000}.type-fighting{background:#c03028}
    .type-poison{background:#a040a0}.type-ground{background:#e0c068;color:#000}
    .type-flying{background:#a890f0}.type-psychic{background:#f85888}
    .type-dark{background:#705848}.type-rock{background:#b8a038}
    .type-bug{background:#a8b820}.type-dragon{background:#7038f8}
    .type-ghost{background:#705898}.type-steel{background:#b8b8d0;color:#000}
    .type-fairy{background:#f0b6bc;color:#000}.type-normal{background:#a8a878}
    table.info-table{ width:100%; border-collapse:collapse; margin:8px auto 0; font-size:clamp(12px,3.2vw,14px); text-align:center }
    .info-table th{background:#f7f7f7; padding:6px; border-bottom:1px solid #ccc; width:40%; font-weight:700}
    .info-table td{padding:6px; border-bottom:1px solid #eee}

    .border-red{border-color:var(--red)!important}
    .border-blue{border-color:var(--blue)!important}
    .border-gray{border-color:var(--gray)!important}

    /* ë± ì„¹ì…˜ */
    .deck-section{
      width:var(--contentW); margin:18px auto 8px;
      border:4px solid #333; border-radius:16px; background:#fff;
      box-shadow:0 0 12px rgba(0,0,0,.12); box-sizing:border-box; display:none;
    }
    .deck-section.show{ display:block }
    .deck-inner{ padding:12px }
    .deck-title{ margin:0 0 10px; font-weight:900 }
    .deck-container{ display:grid; gap:10px; grid-template-columns:repeat(auto-fill, minmax(88px, 1fr)); }
    .deck-card{
      padding:6px; border:3px solid #666; border-radius:10px; background:#fff;
      display:flex; flex-direction:column; align-items:center; cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,.06); transition:transform .15s ease, box-shadow .15s ease;
    }
    .deck-card:hover{ transform:translateY(-1px); box-shadow:0 6px 14px rgba(0,0,0,.10); }
    .deck-card img{width:72px; height:72px; object-fit:contain}
    .deck-card-name{font-size:12px; margin-top:5px; text-transform:capitalize}

    /* ì¬ë³´ê¸°(ë±ì—ì„œ ì„ íƒ) */
    .card.replay{ background:#f9f9f9; border-color:#aaa }

    /* ====== Draw ì—°ì¶œ: 3D í”Œë¦½ & ìŠ¤íŒŒí´ ====== */
    .card-slot{ min-height:0 } /* JSì—ì„œ ë™ì  min-height ì„¸íŒ… */
    .card-wrap{
      width: var(--contentW);
      margin:16px auto;
      position:relative;
      perspective:1000px;
      -webkit-perspective:1000px; /* iOS */
      }
    .card-3d{
      position: relative;
      /* 3D ë³´ì¡´ */
      transform-style: preserve-3d;
      -webkit-transform-style: preserve-3d;
      /* íŠ¸ëœì§€ì…˜ */
      transition: transform var(--flipDur) cubic-bezier(.19,.9,.22,1);      will-change: transform;

      /* iOS ë Œë”ë§ ê¹¨ì§ ë°©ì§€ */
      transform: translateZ(0);
      -webkit-transform: translateZ(0);

      /* backface ìˆ¨ê¹€ ì•ˆì •í™” (ì¶”ê°€) */
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }
    .card-3d.is-flipped{
      transform: rotateY(180deg);
      -webkit-transform: rotateY(180deg);
    }

    .face{
      position:absolute; inset:0; border-radius:16px;

      /* ë’¤ì§‘íŒ ë©´ ìˆ¨ê¸°ê¸° */
      backface-visibility:hidden;
      -webkit-backface-visibility:hidden;

      /* **ì¤‘ìš”**: PC Chrome/Edgeì˜ ë Œë”ë§ ë¬¸ì œë¥¼ í”¼í•˜ê¸° ìœ„í•´
         ì—¬ê¸°ì„œëŠ” translateZë¥¼ ì œê±°í–ˆìŠµë‹ˆë‹¤. (ëª¨ë°”ì¼ í˜¸í™˜ì„±ì€ ìœ ì§€) */
      /* transform: translateZ(0.1px);
      -webkit-transform: translateZ(0.1px); */

      /* iOSì—ì„œ ê¹œë¹¡ì„/ê¹Šì´ ì¶©ëŒ ë°©ì§€ìš©ìœ¼ë¡œ ë¶€ëª¨(.card-3d)ì˜ translateZ(0) ìœ ì§€ */
      }

      /* ì•ë©´ì€ Yë¡œ ë’¤ì§‘ì–´ ë‘ (ë¶€ëª¨ê°€ ëŒì•„ì˜¤ë©° ì •ë©´ í‘œì‹œ) */
      .face.front{
      transform: rotateY(180deg);
      -webkit-transform: rotateY(180deg);
      z-index: 3; /* ì•ë©´ ìš°ì„  í‘œì‹œ */
      }

      .face.back{
      z-index: 2;
      }

    /* ë’·ë©´(ê°„ë‹¨ í¬ì¼“ë³¼í’) */
    .card-back{
    /* í¬ê¸°/ë ˆì´ì–´ */
    height:100%;
    border:4px solid #111;               /* í¬ì¼“ë³¼ í…Œë‘ë¦¬ */
    border-radius:16px;
    box-sizing:border-box;
    position:relative;
    overflow:hidden;
    box-shadow:
        0 2px 10px rgba(0,0,0,.25),
        inset 0 2px 8px rgba(0,0,0,.15);

    /* íŒŒë¼ë¯¸í„°(ë°˜ì‘í˜•) */
    --bandH: clamp(14px, 3.5vw, 22px);   
    --ringOuter: clamp(60px, 15vw, 92px);
    --btn: calc(var(--ringOuter) * .72); /* âœ… ë²„íŠ¼ í¬ê¸°ë¥¼ ë” í‚¤ì›€ */

    /* ë°°ê²½ ë ˆì´ì–´: ìœ„ ë¹¨ê°• / ì•„ë˜ í°ìƒ‰ + ì¤‘ì•™ ê²€ì€ ë  + ìƒë‹¨ í•˜ì´ë¼ì´íŠ¸ */
    background:
        /* ìƒë‹¨ í•˜ì´ë¼ì´íŠ¸(ê´‘íƒ) */
        radial-gradient(120% 80% at 50% -10%,
        rgba(255,255,255,.55) 0%,
        rgba(255,255,255,.20) 22%,
        rgba(255,255,255,0) 48%) ,
        /* ì¤‘ì•™ ê²€ì€ ë  */
        linear-gradient(to bottom,
        transparent calc(50% - var(--bandH)/2),
        #000 calc(50% - var(--bandH)/2) calc(50% + var(--bandH)/2),
        transparent calc(50% + var(--bandH)/2)) ,
        /* ìœ„/ì•„ë˜ ë°˜ë°˜ ìƒ‰ìƒ */
        linear-gradient(to bottom, #e53935 0 50%, #ffffff 50% 100%);
        transform: translateZ(0.1px);
        -webkit-transform: translateZ(0.1px);
    }
    /* í¬ì¼“ë³¼ ì¤‘ì•™ì˜ 'ê²€ì€ ì™¸ê³½ ë§' */
    .card-back::before{
    content:"";
    position:absolute; left:50%; top:50%;
    transform: translate(-50%,-50%);
    width: var(--ringOuter); height: var(--ringOuter);
    border-radius:50%;
    background:
        radial-gradient(circle at 50% 50%,
        rgba(0,0,0,.95) 45%,
        rgba(0,0,0,.95) 60%,
        rgba(0,0,0,0) 61% 100%);
    /* ì™¸ê³½ ë§ì˜ ë³¼ë¥¨ê° */
    box-shadow:
        0 0 0 2px rgba(0,0,0,.85),               /* ì§„í•œ í…Œë‘ë¦¬ */
        inset 0 2px 4px rgba(255,255,255,.25),   /* ë‚´ë¶€ ìœ„ìª½ í•˜ì´ë¼ì´íŠ¸ */
        inset 0 -2px 4px rgba(0,0,0,.35);        /* ë‚´ë¶€ ì•„ë˜ìª½ ìŒì˜ */
    z-index: 1;
    }

    /* í¬ì¼“ë³¼ ì¤‘ì•™ 'í•˜ì–€ ë²„íŠ¼'(í•˜ì´ë¼ì´íŠ¸/ì…ì²´ê° í¬í•¨) */
    .card-back::after{
    content:"";
    position:absolute; left:50%; top:50%;
    transform: translate(-50%,-50%);
    width: var(--btn); height: var(--btn);
    border-radius:50%;
    background:
        /* ë²„íŠ¼ ìƒë‹¨ í•˜ì´ë¼ì´íŠ¸ */
        radial-gradient(140% 100% at 50% 0%,
        rgba(255,255,255,.95) 0%,
        rgba(255,255,255,.75) 28%,
        rgba(255,255,255,.0) 60%),
        /* ë²„íŠ¼ ë³¸ì²´ */
        radial-gradient(circle at 50% 55%,
        #fdfdfd 0%,
        #f1f1f1 60%,
        #e6e6e6 100%);
    box-shadow:
        0 0 0 2px #111,                       /* ë²„íŠ¼ ì™¸ê³½ì„ (ê²€ì€ í…Œë‘ë¦¬) */
        inset 0 4px 8px rgba(255,255,255,.9), /* ìœ„ìª½ ê°•í•œ í•˜ì´ë¼ì´íŠ¸ */
        inset 0 -4px 10px rgba(0,0,0,.25),    /* ì•„ë˜ìª½ ìŒì˜ */
        0 4px 10px rgba(0,0,0,.25);           /* ë°”ê¹¥ ê·¸ë¦¼ì(ë– ë³´ì´ëŠ” íš¨ê³¼) */
    z-index: 2;
    }

    /* (ì„ íƒ) ì‚´ì§ ì‚´ì•„ìˆëŠ” ëŠë‚Œ: ì•„ì£¼ ë¯¸ì„¸í•œ í„ìŠ¤ */
    @media (prefers-reduced-motion: no-preference){
    .card-back::after{
        animation: btnPulse 2.6s ease-in-out infinite;
    }
    @keyframes btnPulse{
        0%,100%{ transform: translate(-50%,-50%) scale(1); }
        50%    { transform: translate(-50%,-50%) scale(1.03); }
    }
    }

    /* ìŠ¤íŒŒí´ ë ˆì´ì–´ */
    .fx-layer{
    position:absolute; inset:-8px; pointer-events:none; overflow:visible;
    /* í…Œë§ˆì— ë”°ë¼ ë°”ë€ŒëŠ” ê¸€ë¡œìš° */
    filter: drop-shadow(0 0 6px var(--fx-glow, rgba(255,220,120,.75)));
    }
    /* ê¸°ë³¸ íŒ”ë ˆíŠ¸ ë³€ìˆ˜(í…Œë§ˆê°€ ì•ˆ ë¶™ì—ˆì„ ë•Œ) */
    .fx-layer{ --spA:#ffffff; --spB:#ffd166; --fx-glow:rgba(255,220,120,.85); }

    /* í…Œë§ˆ: ë¹¨ê°•/íŒŒë‘/ê³¨ë“œ(ê¸°ë³¸) */
    .fx-layer.theme-red  { --spA:#ffffff; --spB:#ff6b6b; --fx-glow: rgba(255,80,80,.85); }
    .fx-layer.theme-blue { --spA:#e6f0ff; --spB:#6ea8ff; --fx-glow: rgba(110,168,255,.90); }
    .fx-layer.theme-gold { --spA:#ffffff; --spB:#ffd166; --fx-glow: rgba(255,220,120,.85); }

    .fx-star,.fx-shard{
    position:absolute; opacity:0; transform: translateZ(0) scale(.6); will-change: transform, opacity;
    }
    /* ë³„(ì›í˜• ê·¸ë¼ë””ì–¸íŠ¸) â€” íŒ”ë ˆíŠ¸ ë³€ìˆ˜ ì‚¬ìš© */
    .fx-star{
    width: var(--sz,10px); height: var(--sz,10px); border-radius:50%;
    background: radial-gradient(circle, var(--spA), var(--spB) 48%, transparent 70%);
    animation: sparkle var(--sparkleDur, 1100ms) ease-out forwards;
    }

    /* ìƒ¤ë“œ(ë¹›ì¡°ê°) â€” íŒ”ë ˆíŠ¸ ë³€ìˆ˜ ì‚¬ìš© */
    .fx-shard{
    width: 2px; height: var(--len,16px);
    background: linear-gradient(var(--spA), var(--spB));
    border-radius: 1px; transform-origin: center bottom;
    animation: shard var(--sparkleDur, 1100ms) ease-out forwards;
    }
    @keyframes sparkle{
      0%{ opacity:0; transform:translateY(6px) scale(.6) rotate(0deg) }
      15%{ opacity:1 }
      100%{ opacity:0; transform:translateY(-24px) scale(1.15) rotate(15deg) }
    }
    @keyframes shard{
      0%{ opacity:0; transform:translateY(10px) rotate(var(--rot,0deg)) scaleY(.8) }
      15%{ opacity:1 }
      100%{ opacity:0; transform:translateY(-28px) rotate(calc(var(--rot,0deg) + 20deg)) scaleY(1.1) }
    }

    @media (prefers-reduced-motion: reduce){
      .card-3d{ transition:none; transform:none!important }
      .fx-star,.fx-shard{ animation:none; opacity:0 }
    }

    /* ëŠ¥ë ¥ì¹˜ ë“±ê¸‰ í‘œì‹œ */
    .grade{ font-weight: 700; }
    .grade-S{ color: #d62828; font-weight: 900; }

    /* Sê¸‰ ëŠ¥ë ¥ì¹˜ëŠ” ìˆ«ì ìì²´ë„ ë¹¨ê°„ìƒ‰/êµµê²Œ */
    .info-table td.s-grade{ color: #d62828; font-weight: 900; }

    /* ë±ì—ì„œ ë‹¤ì‹œ ë³¸ ì¹´ë“œ(ì¬ë³´ê¸°) â€” ì§™ì€ íšŒìƒ‰ ë°°ê²½ */
    #card-slot .card.replay{
    background: #e0e0e0 !important;  /* â† ì§™ì€ íšŒìƒ‰ */
    border-color: #9aa0a6 !important; /* í…Œë‘ë¦¬ë„ ì¡°ê¸ˆ ì–´ë‘¡ê²Œ */
    box-shadow: 0 0 12px rgba(0,0,0,.15); /* ì‚´ì§ ë¬´ê²Œê° */
    }

    /* (ì„ íƒ) ì¬ë³´ê¸° ë±ƒì§€ */
    #card-slot .card.replay .card-name::after{
    content: "ì¹´ë“œë±";
    margin-left: 8px;
    font-size: 12px;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 8px;
    background: #4b5563;
    color: #fff;
    }
  </style>
</head>
<body>
  <h1 class="title">í¬ì¼“ëª¬ ì¹´ë“œ ëœë¤ ë½‘ê¸°</h1>

  <div id="controls">
    <button id="draw-button" class="cta" aria-label="ì¹´ë“œ ë½‘ê¸°">ğŸ´ ì¹´ë“œ ë½‘ê¸° ğŸ´</button>
  </div>

  <div id="status" role="status" aria-live="polite">ì „ì²´ ëª©ë¡ ë¡œë”© ì¤‘â€¦ (ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”)</div>
  <div class="progress-wrap" id="progress-wrap" aria-hidden="false">
    <div class="progress-fill" id="progress-fill" style="width:0%"></div>
  </div>

  <!-- ì¹´ë“œ ìŠ¬ë¡¯: ë ˆì´ì•„ì›ƒ ì•ˆì •í™” ìœ„í•´ min-heightë¥¼ JSë¡œ ë™ì  ì„¸íŒ… -->
  <div id="card-slot" class="card-slot"></div>

  <!-- ë± -->
  <section id="deck-section" class="deck-section" aria-hidden="true">
    <div class="deck-inner">
      <h2 class="deck-title">ë‚´ê°€ ë½‘ì€ ì¹´ë“œ</h2>
      <div class="deck-container" id="deck-container"></div>
    </div>
  </section>

<script>
  /* =============== ì„¤ì •/ìƒíƒœ =============== */
  const POKEMON_INDEX_START = 'https://pokeapi.co/api/v2/pokemon?limit=200&offset=0';
  const speciesAPI = 'https://pokeapi.co/api/v2/pokemon-species/';
  const FETCH_TIMEOUT_MS = 8000;
  const INDEX_FALLBACK_AFTER_MS = 6000;

  let isLoadingIndex = false;
  let indexList = [];
  let nextIndexUrl = POKEMON_INDEX_START;
  let totalCount = null;
  let fallbackMode = false;

  const cache = new Map();

  /* ë“±ê¸‰ */
  const gradeWeights    = { S: 20, A: 35, B: 30, C: 15 };
  const gradeMultiplier = { S: 1.00, A: 0.95, B: 0.90, C: 0.85 };

  const statNamesKor = {
    hp: 'ì²´ë ¥', attack: 'ê³µê²©', defense: 'ë°©ì–´',
    'special-attack': 'íŠ¹ìˆ˜ê³µê²©', 'special-defense': 'íŠ¹ìˆ˜ë°©ì–´', speed: 'ìŠ¤í”¼ë“œ'
  };

  /* ì¿¨ë‹¤ìš´ ë¼ë²¨/ì‹œê°„ */
  const DRAWING_LABEL = 'ğŸ´ ë½‘ëŠ” ì¤‘ ğŸ´';
  const RESUME_LABEL  = 'ğŸ´ ì¹´ë“œ ë½‘ê¸° ğŸ´';
  const COOLDOWN_MS   = 3000;

  /* =============== ìœ í‹¸ =============== */
  const sleep = ms => new Promise(r => setTimeout(r, ms));

  async function fetchJSON(url, retries = 2, backoffMs = 500) {
    for (let i = 0; i <= retries; i++) {
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), FETCH_TIMEOUT_MS);
      try {
        const res = await fetch(url, { signal: controller.signal });
        clearTimeout(t);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return await res.json();
      } catch (e) {
        clearTimeout(t);
        if (i === retries) throw e;
        await sleep(backoffMs * (i + 1));
      }
    }
  }
  function setStatus(msg){ const el = document.getElementById('status'); if (el) el.textContent = msg; }
  function setProgress(pct){ const bar = document.getElementById('progress-fill'); if (bar) bar.style.width = Math.max(0,Math.min(100,pct))+'%'; }
  function toggleProgress(show){ const wrap = document.getElementById('progress-wrap'); if (wrap) wrap.style.display = show?'block':'none'; }

  function pickGrade(){
    const r = Math.random()*100; let acc = 0;
    for (const [g,w] of Object.entries(gradeWeights)){ acc += w; if (r < acc) return g; }
    return 'C';
  }
  function borderClassByGrades(stats){
    let s=0, a=0;
    for (const st of stats){ if (st.grade==='S') s++; else if (st.grade==='A') a++; }
    if (s >= 3) return 'border-red';
    if (s === 2 && a >= 1) return 'border-blue';
    return 'border-gray';
  }
  function genCode(n = 4){
    const chars = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789';
    let out = '';
    for (let i=0;i<n;i++) out += chars[Math.floor(Math.random()*chars.length)];
    return out;
  }

  /* ì¿¨ë‹¤ìš´ */
  function startCooldown(btn, ms = COOLDOWN_MS, resumeLabel = RESUME_LABEL){
    const end = Date.now() + ms;
    btn.setAttribute('disabled', 'true');
    const tick = () => {
      const left = end - Date.now();
      if (left <= 0) {
        btn.removeAttribute('disabled');
        btn.textContent = resumeLabel;
        return;
      }
      const sec = Math.ceil(left / 1000);
      btn.textContent = `â³ ${sec}ì´ˆ ëŒ€ê¸° ì¤‘â€¦`;
      requestAnimationFrame(tick);
    };
    tick();
  }

  /* ========== Draw ì—°ì¶œ ìœ í‹¸ ========== */
  /* ë°˜ì§ì´ ìƒì„± */
  function addSparkles(target, count = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sparkleCount')) || 26){
    if(!target) return;
    const rect = target.getBoundingClientRect();
    const mk = (cls, x, y, delay) => {
      const el = document.createElement('span');
      el.className = cls;
      el.style.left = x + 'px';
      el.style.top  = y + 'px';
      el.style.animationDelay = delay + 'ms';
      target.appendChild(el);
      return el;
    };
    for(let i=0;i<count;i++){
      const x = Math.random()*(rect.width-8);
      const y = Math.random()*(rect.height-8) + 8;
      const delay = Math.random()*220|0;

      if (Math.random() < 0.65){
        const s = mk('fx-star', x, y, delay);
        s.style.setProperty('--sz', (8 + Math.random()*10) + 'px');
      } else {
        const sh = mk('fx-shard', x, y, delay);
        sh.style.setProperty('--len', (12 + Math.random()*22) + 'px');
        sh.style.setProperty('--rot', (Math.random()*60 - 30) + 'deg');
      }
      setTimeout(()=> target.firstChild && target.removeChild(target.firstChild), 1400); // ìì—° ì •ë¦¬
    }
  }
  /* í”Œë¦½ ë§ˆí¬ì—… */
  function renderFlipCardMarkup(frontHTML){
    return `
      <div class="card-wrap">
        <div class="card-3d" id="card3d">
          <div class="face back">
            <div class="card-back" aria-hidden="true"></div>
          </div>
          <div class="face front">
            ${frontHTML}
          </div>
        </div>
        <div class="fx-layer"></div>
      </div>
    `;
  }
  /* ë ˆì´ì•„ì›ƒ ì•ˆì •: ì•ë©´ ë†’ì´ ë¯¸ë¦¬ ì¸¡ì •í•´ card-slotì— ê³ ì • */
  function measureFrontHeight(frontHTML){
    const probe = document.createElement('div');
    probe.style.cssText = 'position:absolute;visibility:hidden;pointer-events:none;left:-9999px;top:-9999px;width:'+getComputedStyle(document.documentElement).getPropertyValue('--contentW');
    probe.innerHTML = frontHTML;
    document.body.appendChild(probe);
    const h = probe.offsetHeight;
    document.body.removeChild(probe);
    return h;
  }

  /* =============== ì¸ë±ìŠ¤ ë¡œë”© =============== */
  function buildFallbackIndex(maxId = 1025){
    const arr = [];
    for(let id=1; id<=maxId; id++){
      arr.push({ name: String(id), url: `https://pokeapi.co/api/v2/pokemon/${id}` });
    }
    return arr;
  }

  async function loadIndexAll(){
    if (!nextIndexUrl || isLoadingIndex) return;
    isLoadingIndex = true;
    toggleProgress(true);
    setStatus('ì „ì²´ ëª©ë¡ ë¡œë”© ì¤‘â€¦ (ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”)');

    const fbTimer = setTimeout(()=>{
      if (!indexList.length) {
        fallbackMode = true;
        indexList = buildFallbackIndex();
        totalCount = indexList.length;
        setProgress(30);
        setStatus('ë¹ ë¥¸ ì‹œì‘ ëª¨ë“œë¡œ ì „í™˜: ì¸ë±ìŠ¤ê°€ ëŠë ¤ì„œ ID ê¸°ë°˜ìœ¼ë¡œ ë°”ë¡œ ë½‘ì„ ìˆ˜ ìˆì–´ìš”.');
      }
    }, INDEX_FALLBACK_AFTER_MS);

    try{
      while (nextIndexUrl) {
        const page = await fetchJSON(nextIndexUrl);
        totalCount ??= page.count || 0;

        if (fallbackMode && page?.results?.length) {
          fallbackMode = false;
          indexList = [];
          setStatus('ì •ì‹ ì¸ë±ìŠ¤ ì—°ê²°ë¨. ë°ì´í„° ì •í™•ë„ë¥¼ ë†’ì´ëŠ” ì¤‘â€¦');
        }
        indexList.push(...page.results);
        nextIndexUrl = page.next;

        const pct = totalCount ? Math.round((indexList.length / totalCount) * 100) : 0;
        setStatus(`ì „ì²´ ëª©ë¡ ë¡œë”© ì¤‘â€¦ ${indexList.length}/${totalCount || '?'} (${pct}%)`);
        setProgress(pct);
        if (nextIndexUrl) await sleep(150);
      }
      clearTimeout(fbTimer);
      setStatus(`ëª©ë¡ ë¡œë”© ì™„ë£Œ! ì´ ${indexList.length}ë§ˆë¦¬`);
      setProgress(100);
      toggleProgress(false);
    }catch(e){
      clearTimeout(fbTimer);
      console.error(e);
      if (!indexList.length){
        fallbackMode = true;
        indexList = buildFallbackIndex();
        totalCount = indexList.length;
        setStatus('ì¸ë±ìŠ¤ ë¡œë”© ì‹¤íŒ¨ â†’ ë¹ ë¥¸ ì‹œì‘ ëª¨ë“œë¡œ ê³„ì†í•©ë‹ˆë‹¤.');
      }else{
        setStatus('ì¼ë¶€ ì¸ë±ìŠ¤ ë¡œë”© ì‹¤íŒ¨ (ë„¤íŠ¸ì›Œí¬/ë ˆì´íŠ¸ ë¦¬ë°‹ ê°€ëŠ¥). ê³„ì† ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
      }
      toggleProgress(false);
    }finally{
      isLoadingIndex = false;
    }
  }

  /* =============== ìƒì„¸ ë¡œë”© + ìºì‹œ =============== */
  async function getPokemonDetail(urlOrName){
    if (cache.has(urlOrName)) return cache.get(urlOrName);

    const info = await fetchJSON(
      (typeof urlOrName==='string' && urlOrName.startsWith('http')) ? urlOrName
        : `https://pokeapi.co/api/v2/pokemon/${urlOrName}`
    );
    const species = await fetchJSON(info.species?.url || (speciesAPI + info.name));

    const nameKo = species?.names?.find(n=>n.language.name==='ko')?.name || info.name || 'ì´ë¦„ ì—†ìŒ';
    const types  = (info.types || []).map(t=>t.type.name);
    const stats  = (info.stats || []).map(s=>{
      const g = pickGrade();
      return { name:s.stat.name, value: Math.round(s.base_stat * ( {S:1.00,A:0.95,B:0.90,C:0.85}[g] )), grade:g };
    });
    const flavor = (species?.flavor_text_entries?.find(e=>e.language.name==='ko')?.flavor_text || '')
                    .replace(/\n|\f/g,' ') || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.';

    const thumb =
      info.sprites?.front_default ||
      info.sprites?.other?.dream_world?.front_default ||
      info.sprites?.other?.home?.front_default ||
      info.sprites?.other?.['official-artwork']?.front_default || '';
    const image =
      info.sprites?.other?.['official-artwork']?.front_default ||
      info.sprites?.other?.home?.front_default || thumb;

    const obj = { id: info.id, nameKo, image, thumb, types, stats, flavor };
    cache.set(urlOrName, obj);
    cache.set(info.name, obj);
    cache.set(info.id, obj);
    if (info.species?.url) cache.set(info.species.url, obj);
    return obj;
  }

  /* =============== ë Œë”ë§ (ì•ë©´) =============== */
  function renderCard(p){
    const borderCls = borderClassByGrades(p.stats || []);
    const badgeHTML = (p.types||[]).map(t=>`<span class="type-badge type-${t}">${t}</span>`).join(' ');
    const rows = (p.stats||[]).map(s=>{
      const isS = s.grade==='S';
      return `
        <tr>
        <th>${statNamesKor[s.name] || s.name}</th>
        <td class="${isS ? 's-grade' : ''}">
            ${s.value}
            ${s.grade ? ` <span class="grade ${isS?'grade-S':''}">(${s.grade})</span>` : ''}
        </td>
        </tr>`;
    }).join('');
    return `
      <div class="card ${borderCls}">
        <img src="${p.image}" alt="${p.nameKo}" loading="eager" decoding="async">
        <div class="card-name">${p.nameKo} (#${p.id})</div>
        <div style="margin-bottom:6px;">${badgeHTML || ''}</div>
        <table class="info-table">
          <tr><th>ì„¤ëª…</th><td>${p.flavor}</td></tr>
          ${rows}
        </table>
      </div>
    `;
  }

  /* =============== ì‚¬ìš´ë“œ(ë¾°ë¡œë¡±) =============== */
  let audioCtx = null;
  function playChime(){
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const ctx = audioCtx, now = ctx.currentTime, freqs=[880,1175,1568];
      freqs.forEach((f, i)=>{
        const o = ctx.createOscillator(), g = ctx.createGain();
        o.type = 'sine';
        o.frequency.setValueAtTime(f*0.9, now + i*0.05);
        o.frequency.exponentialRampToValueAtTime(f*1.1, now + i*0.05 + 0.32);
        g.gain.setValueAtTime(0.0001, now + i*0.05);
        g.gain.exponentialRampToValueAtTime(0.26, now + i*0.05 + 0.04);
        g.gain.exponentialRampToValueAtTime(0.0001, now + i*0.05 + 0.36);
        o.connect(g).connect(ctx.destination);
        o.start(now + i*0.05); o.stop(now + i*0.05 + 0.38);
      });
    }catch(_){}
  }

  /* =============== ì´ë²¤íŠ¸ =============== */
  const drawBtn = document.getElementById('draw-button');
  let isDrawing = false;

  drawBtn.addEventListener('click', async ()=>{
    if (isDrawing) return;
    isDrawing = true;
    drawBtn.textContent = DRAWING_LABEL;
    drawBtn.setAttribute('disabled', 'true');

    if (!indexList.length) {
      fallbackMode = true;
      indexList = buildFallbackIndex();
      totalCount = indexList.length;
      setStatus('ë¹ ë¥¸ ì‹œì‘ ëª¨ë“œ: ì¸ë±ìŠ¤ ì—†ì´ ë°”ë¡œ ë½‘ê¸°ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.');
      toggleProgress(false);
    }

    const meta = indexList[Math.floor(Math.random()*indexList.length)];
    setStatus('ìƒì„¸ ë¡œë”© ì¤‘â€¦');
    try{
      const pick = await getPokemonDetail(meta.url || meta.name);

      // ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ (ê¹œë¹¡ì„ ê°ì†Œ)
      if (pick.image) {
        const pre = new Image(); pre.src = pick.image;
        try { await pre.decode?.(); } catch(_) {}
      }

      playChime();

      const slot = document.getElementById('card-slot');

      // 1) ì•ë©´ HTML ìƒì„± & ë†’ì´ ì¸¡ì • â†’ ë ˆì´ì•„ì›ƒ ê³ ì •
      const frontHTML = renderCard(pick);
      const h = measureFrontHeight(frontHTML);
      slot.style.minHeight = h + 'px';

      // 2) í”Œë¦½ ë§ˆí¬ì—… ì£¼ì…
      slot.innerHTML = renderFlipCardMarkup(frontHTML);
      // â–¶ ì¹´ë“œ ë“±ê¸‰(ë³´ë”) â†’ ìŠ¤íŒŒí´ í…Œë§ˆ ë§¤í•‘
      const borderCls = borderClassByGrades(pick.stats || []);
      const fxLayer = slot.querySelector('.fx-layer');
      if (borderCls === 'border-red') {
      fxLayer.classList.add('theme-red');
      } else if (borderCls === 'border-blue') {
      fxLayer.classList.add('theme-blue');
      } else {
      fxLayer.classList.add('theme-gold'); // ê¸°ë³¸(ë…¸ë€ ëŠë‚Œ)
      }
            
      // 3) ë°˜ì§ì´ ê°•í™”
      addSparkles(fxLayer);
      
      // 4) ë‹¤ìŒ í”„ë ˆì„ì— í”Œë¦½ íŠ¸ë¦¬ê±°(ë’¤â†’ì•, 6.5s)
      const card3d = slot.querySelector('#card3d');
      card3d.style.height = h + 'px';

      // ê°•ì œ ë¦¬í”Œë¡œìš° + ë”ë¸” RAF (iOS ì•ˆì •í™” í•µì‹¬) â€” ìœ ì§€
      void card3d.offsetWidth;
      requestAnimationFrame(()=>{
        requestAnimationFrame(()=>{
          card3d.classList.add('is-flipped');  // ì´ì œ ë’¤â†’ì• íšŒì „ í™•ì •
        });
      });

      // ë± ì„¹ì…˜ í‘œì‹œ & ì¸ë„¤ì¼ ì¶”ê°€
      const deckSection = document.getElementById('deck-section');
      if (!deckSection.classList.contains('show')){
        deckSection.classList.add('show');
        deckSection.setAttribute('aria-hidden','false');
      }
      const deck = document.getElementById('deck-container');
      const div = document.createElement('div');
      div.className = 'deck-card';
      div.innerHTML = `<img src="${pick.thumb || pick.image}" alt="" loading="lazy" decoding="async"><div class="deck-card-name">${pick.nameKo}</div>`;
      div.addEventListener('click', ()=>{        
      const slot = document.getElementById('card-slot');
      slot.classList.remove('is-replay');     // ìŠ¬ë¡¯ í”Œë˜ê·¸ ì œê±°
      slot.innerHTML = '';                    // ë‚´ìš© ì´ˆê¸°í™” (ì„ íƒ)

      // ì¬ë³´ê¸°ëŠ” í”Œë¦½ ì—†ì´, ì•ë©´ë§Œ ê³§ì¥ ë Œë”
      slot.style.minHeight = '';            // ê³ ì • í•´ì œ
      slot.innerHTML = renderCard(pick);
      const cardEl = slot.querySelector('.card');
      if (cardEl) cardEl.classList.add('replay');  // â† ì§™ì€ íšŒìƒ‰ ì ìš© í¬ì¸íŠ¸
      // (ì„ íƒ) ìŠ¬ë¡¯ ìƒíƒœ í”Œë˜ê·¸
      slot.classList.add('is-replay');
      window.scrollTo({ top: 0, behavior: 'smooth' });
      });
      deck.appendChild(div);
      
      // ê³ ìœ ë²ˆí˜¸ ìƒíƒœ
      const uniq = genCode(4);
      setStatus(`ê³ ìœ ë²ˆí˜¸ : #${uniq}`);
    }catch(e){
      console.error(e);
      setStatus('ìƒì„¸ ë¡œë”© ì‹¤íŒ¨ (ë„¤íŠ¸ì›Œí¬/ë ˆì´íŠ¸ ë¦¬ë°‹ ê°€ëŠ¥). ë‹¤ë¥¸ ì¹´ë“œë¥¼ ì‹œë„í•´ ë³´ì„¸ìš”.');
    } finally {
      isDrawing = false;
      startCooldown(drawBtn, COOLDOWN_MS, RESUME_LABEL);
    }
  });

  /* =============== ì´ˆê¸° =============== */
  (async function init(){ await loadIndexAll(); })();
</script>
</body>
</html>
